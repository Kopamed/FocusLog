<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FocusLog Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #0f0f0f;
        color: #e0e0e0;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: #1a1a1a;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 10px;
        color: #00ff88;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
      }

      .stat-card h3 {
        font-size: 0.9em;
        color: #888;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .value {
        font-size: 2em;
        font-weight: bold;
        color: #00ff88;
      }

      .chart-container {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
        margin-bottom: 20px;
      }

      .chart-container h2 {
        margin-bottom: 20px;
        color: #e0e0e0;
      }

      canvas {
        max-height: 400px;
      }

      .filters {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
        margin-bottom: 20px;
      }

      .filters label {
        margin-right: 10px;
        color: #888;
      }

      .filters input,
      .filters select {
        background: #0f0f0f;
        color: #e0e0e0;
        border: 1px solid #2a2a2a;
        padding: 8px 12px;
        border-radius: 4px;
        margin-right: 15px;
      }

      .filters button {
        background: #00ff88;
        color: #0f0f0f;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }

      .filters button:hover {
        background: #00dd77;
      }

      .summaries-container {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
        margin-bottom: 20px;
      }

      .summary-item {
        background: #0f0f0f;
        padding: 15px;
        border-radius: 4px;
        border-left: 3px solid #00ff88;
        margin-bottom: 15px;
      }

      .summary-item .time {
        color: #888;
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .summary-item .type {
        display: inline-block;
        background: #00ff88;
        color: #0f0f0f;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
        margin-right: 10px;
      }

      .captures-list {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
      }

      .capture-item {
        background: #0f0f0f;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
        border-left: 3px solid #555;
      }

      .capture-item .timestamp {
        color: #888;
        font-size: 0.85em;
        margin-bottom: 5px;
      }

      .capture-item .labels {
        margin-bottom: 8px;
      }

      .label-tag {
        display: inline-block;
        background: #2a2a2a;
        color: #00ff88;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      .capture-item .description {
        color: #b0b0b0;
        font-size: 0.9em;
      }

      .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2col {
          grid-template-columns: 1fr;
        }
      }

      /* Swimlanes Timeline */
      #swimlanes {
        position: relative;
        min-height: 400px;
        overflow-x: auto;
        overflow-y: visible;
      }

      .swimlane {
        position: relative;
        height: 40px;
        margin-bottom: 5px;
        background: #0f0f0f;
        border-radius: 4px;
      }

      .swimlane-label {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.85em;
        color: #888;
        font-weight: 500;
        z-index: 10;
        pointer-events: none;
      }

      .swimlane-bar {
        position: absolute;
        height: 30px;
        top: 5px;
        background: #00ff88;
        border-radius: 3px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .swimlane-bar:hover {
        opacity: 0.8;
      }

      .time-axis {
        position: sticky;
        left: 0;
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        margin-top: 10px;
        border-top: 1px solid #2a2a2a;
        font-size: 0.8em;
        color: #888;
      }

      /* Heatmap */
      #heatmap {
        display: grid;
        grid-template-columns: 40px repeat(24, 1fr);
        gap: 2px;
        font-size: 0.7em;
      }

      .heatmap-hour-label {
        grid-column: span 1;
        text-align: center;
        padding: 5px 2px;
        color: #888;
        font-size: 0.9em;
      }

      .heatmap-day-label {
        text-align: right;
        padding: 5px;
        color: #888;
      }

      .heatmap-cell {
        aspect-ratio: 1;
        border-radius: 2px;
        cursor: pointer;
        transition: transform 0.1s;
      }

      .heatmap-cell:hover {
        transform: scale(1.1);
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸŽ¯ FocusLog Dashboard</h1>
        <p>Real-time activity tracking and analytics</p>
      </header>

      <div class="stats-grid" id="stats-grid">
        <!-- Stats will be loaded here -->
      </div>

      <div class="filters">
        <label>Date Range:</label>
        <input type="datetime-local" id="start-date" />
        <label>to</label>
        <input type="datetime-local" id="end-date" />
        <button onclick="applyFilters()">Apply</button>
        <button onclick="setToday()">Today</button>
        <button onclick="setLast24h()">Last 24h</button>
        <button onclick="setLast7d()">Last 7 days</button>
      </div>

      <div class="chart-container">
        <h2>Time by Label</h2>
        <canvas id="labelTimeChart"></canvas>
      </div>

      <div class="chart-container">
        <h2>Activity Swimlanes (Timeline)</h2>
        <div id="swimlanes"></div>
      </div>

      <div class="chart-container">
        <h2>Activity Heatmap (Last 7 Days)</h2>
        <div id="heatmap"></div>
      </div>

      <div class="grid-2col">
        <div class="summaries-container">
          <h2>Recent Summaries</h2>
          <div id="summaries-list"></div>
        </div>

        <div class="captures-list">
          <h2>Recent Captures</h2>
          <div id="captures-list"></div>
        </div>
      </div>
    </div>

    <script>
      // Global chart instances
      let labelTimeChart;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        setLast24h();
        loadStats();
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
      });

      function loadStats() {
        fetch("/api/stats")
          .then((r) => r.json())
          .then((data) => {
            const grid = document.getElementById("stats-grid");
            grid.innerHTML = `
                        <div class="stat-card">
                            <h3>Total Captures</h3>
                            <div class="value">${data.total_captures}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Labels</h3>
                            <div class="value">${data.total_labels}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Database Size</h3>
                            <div class="value">${data.total_size_mb} MB</div>
                        </div>
                        <div class="stat-card">
                            <h3>5-Min Summaries</h3>
                            <div class="value">${data.five_min_summaries}</div>
                        </div>
                    `;
          });
      }

      function loadData() {
        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;

        loadLabelTime(start, end);
        loadSwimlanes(start, end);
        loadHeatmap();
        loadSummaries();
        loadCaptures();
      }

      function loadLabelTime(start, end) {
        let url = "/api/label_time";
        if (start && end) {
          url += `?start=${start}&end=${end}`;
        }

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            const labels = data.map((d) => d.label);
            const hours = data.map((d) => d.hours);
            const minutes = data.map((d) => d.minutes);

            // Bar chart
            const ctx1 = document.getElementById("labelTimeChart");
            if (labelTimeChart) labelTimeChart.destroy();
            labelTimeChart = new Chart(ctx1, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Hours",
                    data: hours,
                    backgroundColor: "#00ff88",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const hours = Math.floor(context.raw);
                        const minutes = Math.round((context.raw - hours) * 60);
                        if (hours > 0 && minutes > 0) {
                          return `${hours}h ${minutes}m`;
                        } else if (hours > 0) {
                          return `${hours}h`;
                        } else {
                          return `${minutes}m`;
                        }
                      },
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      color: "#888",
                      callback: function (value) {
                        const hours = Math.floor(value);
                        const minutes = Math.round((value - hours) * 60);
                        if (hours > 0 && minutes > 0) {
                          return `${hours}h ${minutes}m`;
                        } else if (hours > 0) {
                          return `${hours}h`;
                        } else if (minutes > 0) {
                          return `${minutes}m`;
                        } else {
                          return "0";
                        }
                      },
                    },
                    grid: { color: "#2a2a2a" },
                  },
                  x: {
                    ticks: { color: "#888" },
                    grid: { display: false },
                  },
                },
              },
            });
          });
      }

      function loadSwimlanes(start, end) {
        let url = "/api/timeline";
        if (start && end) {
          url += `?start=${start}&end=${end}`;
        }

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            if (data.length === 0) {
              document.getElementById("swimlanes").innerHTML =
                '<p style="color: #888;">No data for this time range</p>';
              return;
            }

            // Get all unique labels and timestamps
            const allLabels = [...new Set(data.map((d) => d.label))].sort();
            const timestamps = data.map((d) => new Date(d.timestamp).getTime());
            const minTime = Math.min(...timestamps);
            const maxTime = Math.max(...timestamps);
            const timeRange = maxTime - minTime || 1;

            // Group captures by label
            const labelData = {};
            allLabels.forEach((label) => {
              labelData[label] = data.filter((d) => d.label === label);
            });

            const colors = generateColors(allLabels.length);
            const colorMap = {};
            allLabels.forEach((label, i) => {
              colorMap[label] = colors[i];
            });

            // Build swimlanes HTML
            let html = "";
            allLabels.forEach((label) => {
              const captures = labelData[label];
              html += `<div class="swimlane">`;
              html += `<div class="swimlane-label">${label}</div>`;

              captures.forEach((capture) => {
                const captureTime = new Date(capture.timestamp).getTime();
                const position = ((captureTime - minTime) / timeRange) * 100;
                // Each capture represents 15 seconds, scale width accordingly
                const width = (15000 / timeRange) * 100;

                html += `<div class="swimlane-bar" 
                                style="left: ${position}%; width: ${Math.max(
                  width,
                  0.5
                )}%; background-color: ${colorMap[label]}" 
                                title="${capture.timestamp} - ${label}"></div>`;
              });

              html += `</div>`;
            });

            // Add time axis
            const formatTime = (ts) => {
              const d = new Date(ts);
              return d.toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
              });
            };

            html += '<div class="time-axis">';
            html += `<span>${formatTime(minTime)}</span>`;
            html += `<span>${formatTime((minTime + maxTime) / 2)}</span>`;
            html += `<span>${formatTime(maxTime)}</span>`;
            html += "</div>";

            document.getElementById("swimlanes").innerHTML = html;
          });
      }

      function loadHeatmap() {
        fetch("/api/heatmap?days=7")
          .then((r) => r.json())
          .then((data) => {
            const dates = [...new Set(data.map((d) => d.date))]
              .sort()
              .reverse(); // Most recent first
            const hours = Array.from({ length: 24 }, (_, i) => i);

            if (dates.length === 0) {
              document.getElementById("heatmap").innerHTML =
                '<p style="color: #888;">No data yet</p>';
              return;
            }

            // Find max count for scaling
            const maxCount = Math.max(...data.map((d) => d.count));

            let html = "<div></div>"; // Empty corner cell

            // Hour labels
            hours.forEach((hour) => {
              html += `<div class="heatmap-hour-label">${hour}</div>`;
            });

            // Rows for each day
            dates.forEach((date) => {
              // Day label
              html += `<div class="heatmap-day-label">${date}</div>`;

              // Hour cells
              hours.forEach((hour) => {
                const item = data.find(
                  (d) => d.date === date && d.hour === hour
                );
                const count = item ? item.count : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor =
                  count === 0
                    ? "#1a1a1a"
                    : `rgba(0, 255, 136, ${0.2 + intensity * 0.8})`;

                html += `<div class="heatmap-cell" 
                                style="background-color: ${bgColor}"
                                title="${date} ${hour}:00 - ${count} captures"></div>`;
              });
            });

            document.getElementById("heatmap").innerHTML = html;
          });
      }

      function loadSummaries() {
        fetch("/api/recent_summaries?limit=5")
          .then((r) => r.json())
          .then((data) => {
            const list = document.getElementById("summaries-list");
            if (data.length === 0) {
              list.innerHTML = '<p style="color: #888;">No summaries yet</p>';
              return;
            }
            list.innerHTML = data
              .map(
                (s) => `
                        <div class="summary-item">
                            <div class="time">
                                <span class="type">${s.type}</span>
                                ${s.start_time} â†’ ${s.end_time}
                            </div>
                            <div>${s.content}</div>
                            ${
                              s.video_path && s.type === "hourly"
                                ? `
                                <div style="margin-top: 10px;">
                                    <video controls width="100%" style="max-height: 300px; border-radius: 4px;">
                                        <source src="/api/video/${s.id}" type="video/mp4">
                                        Your browser does not support video playback.
                                    </video>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    `
              )
              .join("");
          });
      }

      function loadCaptures() {
        fetch("/api/recent_captures?limit=10")
          .then((r) => r.json())
          .then((data) => {
            const list = document.getElementById("captures-list");
            if (data.length === 0) {
              list.innerHTML = '<p style="color: #888;">No captures yet</p>';
              return;
            }
            list.innerHTML = data
              .map(
                (c) => `
                        <div class="capture-item">
                            <div class="timestamp">${c.timestamp}</div>
                            <div class="labels">
                                ${c.labels
                                  .map(
                                    (l) => `<span class="label-tag">${l}</span>`
                                  )
                                  .join("")}
                            </div>
                            <div class="description">${
                              c.description || "No description"
                            }</div>
                        </div>
                    `
              )
              .join("");
          });
      }

      function generateColors(count) {
        const colors = [
          "#00ff88",
          "#ff0088",
          "#00ddff",
          "#ffaa00",
          "#aa00ff",
          "#ff5555",
          "#55ff55",
          "#5555ff",
          "#ffff55",
          "#ff55ff",
        ];
        return Array.from(
          { length: count },
          (_, i) => colors[i % colors.length]
        );
      }

      function setToday() {
        const now = new Date();
        const startOfDay = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          0,
          0,
          0
        );
        document.getElementById("start-date").value = startOfDay
          .toISOString()
          .slice(0, 16);
        document.getElementById("end-date").value = now
          .toISOString()
          .slice(0, 16);
        loadData();
      }

      function setLast24h() {
        const end = new Date();
        const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
        document.getElementById("start-date").value = start
          .toISOString()
          .slice(0, 16);
        document.getElementById("end-date").value = end
          .toISOString()
          .slice(0, 16);
        loadData();
      }

      function setLast7d() {
        const end = new Date();
        const start = new Date(end.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById("start-date").value = start
          .toISOString()
          .slice(0, 16);
        document.getElementById("end-date").value = end
          .toISOString()
          .slice(0, 16);
        loadData();
      }

      function applyFilters() {
        loadData();
      }
    </script>
  </body>
</html>
